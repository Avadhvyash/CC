@use 'sass:list';
@use 'sass:map';
@use 'sass:meta';
@use '../../theming/palette';
@use '../../theming/theming' as theming;
@use '../../typography/all-typography';
@use '../../style/sass-utils';

@use './mat/card' as tokens-mat-card;
@use './mat/radio' as tokens-mat-radio;
@use './mat/snack-bar' as tokens-mat-snack-bar;
@use './mat/tab-header' as tokens-mat-tab-header;
@use './mat/tab-header-with-background' as tokens-mat-tab-header-with-background;
@use './mdc/checkbox' as tokens-mdc-checkbox;
@use './mdc/circular-progress' as tokens-mdc-circular-progress;
@use './mdc/dialog' as tokens-mdc-dialog;
@use './mdc/elevated-card' as tokens-mdc-elevated-card;
@use './mdc/icon-button' as tokens-mdc-icon-button;
@use './mdc/linear-progress' as tokens-mdc-linear-progress;
@use './mdc/list' as tokens-mdc-list;
@use './mdc/outlined-card' as tokens-mdc-outlined-card;
@use './mdc/radio' as tokens-mdc-radio;
@use './mdc/snack-bar' as tokens-mdc-snack-bar;
@use './mdc/tab' as tokens-mdc-tab;
@use './mdc/tab-indicator' as tokens-mdc-tab-indicator;

// Option to save the original theme object into the tokens map, so that theme mixins can continue
// using it while migration to tokens is in progress.
$_enable-back-compat-theme-access: true;

// Gets the tokens for the given theme, m2 tokens module, and theming system.
// Valid theming systems are: unthemable, color, typography, density.
@function _get-tokens-for-module-and-system($theme, $module, $system) {
  @if $system == unthemable {
    @return meta.call(
        meta.get-function(get-#{$system}-tokens, $module: $module));
  }
  @return meta.call(
      meta.get-function(get-#{$system}-tokens, $module: $module), map.get($theme, $system));
}

// Gets the fully qualified tokens map for the given theme and m2 tokens module.
@function _get-tokens-for-module($theme, $module) {
  $tokens: sass-utils.deep-merge-all(
      _get-tokens-for-module-and-system($theme, $module, unthemable),
      _get-tokens-for-module-and-system($theme, $module, color),
      _get-tokens-for-module-and-system($theme, $module, typography),
      _get-tokens-for-module-and-system($theme, $module, density));
  @return map.set((), map.get(meta.module-variables($module), prefix), $tokens);
}

// Gets the full set of m2 tokens for the given theme object. If parts of the theme are missing
// (color, density, etc), defaults are used. Returned format:
// (
//   (fully, qualified, namespace): (
//     token: value
//   )
// )
@function m2-tokens-from-theme($theme: null) {
  $full-theme: map.merge((
    color: theming.define-light-theme(
        theming.define-palette(palette.$indigo-palette),
        theming.define-palette(palette.$pink-palette),
    ),
    typography: all-typography.define-typography-config(),
    density: 0
  ), $theme or ());

  $tokens: sass-utils.deep-merge-all(
      _get-tokens-for-module($full-theme, tokens-mat-card),
      _get-tokens-for-module($full-theme, tokens-mat-radio),
      _get-tokens-for-module($full-theme, tokens-mat-snack-bar),
      _get-tokens-for-module($full-theme, tokens-mat-tab-header),
      _get-tokens-for-module($full-theme, tokens-mat-tab-header-with-background),
      _get-tokens-for-module($full-theme, tokens-mdc-checkbox),
      _get-tokens-for-module($full-theme, tokens-mdc-circular-progress),
      _get-tokens-for-module($full-theme, tokens-mdc-dialog),
      _get-tokens-for-module($full-theme, tokens-mdc-elevated-card),
      _get-tokens-for-module($full-theme, tokens-mdc-icon-button),
      _get-tokens-for-module($full-theme, tokens-mdc-linear-progress),
      _get-tokens-for-module($full-theme, tokens-mdc-list),
      _get-tokens-for-module($full-theme, tokens-mdc-outlined-card),
      _get-tokens-for-module($full-theme, tokens-mdc-radio),
      _get-tokens-for-module($full-theme, tokens-mdc-snack-bar),
      _get-tokens-for-module($full-theme, tokens-mdc-tab),
      _get-tokens-for-module($full-theme, tokens-mdc-tab-indicator),
  );

  @if $_enable-back-compat-theme-access and $theme {
    $tokens: map.deep-merge($tokens, (back-compat: (theme: $theme)));
  }
  @return $tokens;
}
